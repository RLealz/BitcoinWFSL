### 1. **CSP Configuration**
Your existing CSP is mostly correct but needs refinement for reCAPTCHA:

```typescript
// Update helmet config in index.tsx
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      // ... other directives
      scriptSrc: [
        "'self'",
        "'unsafe-inline'", // Required for reCAPTCHA callbacks
        "https://www.google.com/recaptcha/",
        "https://www.gstatic.com/recaptcha/"
      ],
      frameSrc: [
        "'self'",
        "https://www.google.com/recaptcha/",
        "https://recaptcha.google.com/"
      ],
      // ... other directives
    },
  },
  // ... other helmet options
}));
```

---

### 2. **CSRF Token Integration**
Ensure the CSRF token is included in API requests:

**Frontend Example**:
```javascript
// Get CSRF token from cookie
function getCsrfToken() {
  return document.cookie
    .split('; ')
    .find(row => row.startsWith('x-csrf-token='))
    ?.split('=')[1];
}

// Include token in headers
fetch('/api/leads', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': getCsrfToken() // Critical for CSRF protection
  },
  body: JSON.stringify({ 
    captchaToken: 'RECAPTCHA_TOKEN',
    // ... other data
  })
});
```

---

### 3. **reCAPTCHA Script Loading**
Ensure the reCAPTCHA script is loaded in your HTML template:

```html
<!-- In your HTML head -->
<script src="https://www.google.com/recaptcha/api.js?render=YOUR_SITE_KEY"></script>
```

---

### 4. **Critical Fixes**
1. **Verify reCAPTCHA Initialization**:
   - For **v2 Checkbox**:
     ```html
     <div class="g-recaptcha" data-sitekey="YOUR_SITE_KEY"></div>
     ```
   - For **v2 Invisible**:
     ```javascript
     window.onSubmit = async () => {
       const token = await grecaptcha.execute('YOUR_SITE_KEY', { action: 'submit' });
       // Include token in your API request
     };
     ```

2. **Check Environment Variables**:
   Ensure these are set in your `.env`:
   ```
   RECAPTCHA_SECRET_KEY=your_secret_key
   SESSION_SECRET=your_secure_random_string
   ```

3. **Domain Whitelisting**:
   Add your domain (e.g., `localhost`, Replit URL) to the **Allowed Domains** in the [Google reCAPTCHA Admin Console](https://www.google.com/recaptcha/admin/).

---

### 5. **Debugging Steps**
1. **Test reCAPTCHA Isolation**:
   Create a minimal HTML page to verify reCAPTCHA works outside your app.

2. **Check Network Requests**:
   - In browser dev tools:
     - Confirm `recaptcha__en.js` loads without errors.
     - Verify the token is sent to `/api/leads`.
   - In server logs:
     - Look for `Verifying reCAPTCHA token...` from `routes.ts`.

3. **Verify CSP Headers**:
   Check response headers for:
   ```
   content-security-policy: ... script-src 'self' https://www.google.com/recaptcha/ ...
   ```

---

### Example Frontend Integration (v2 Invisible)
```javascript
// In your form component
window.onSubmit = async (e) => {
  e.preventDefault();
  
  try {
    const token = await grecaptcha.execute('YOUR_SITE_KEY', { action: 'submit' });
    const response = await fetch('/api/leads', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': getCsrfToken() // Get from cookie
      },
      body: JSON.stringify({ 
        captchaToken: token,
        name: 'John Doe',
        email: 'john@example.com'
      })
    });
    
    console.log(await response.json());
  } catch (error) {
    console.error('Submission failed:', error);
  }
};
```