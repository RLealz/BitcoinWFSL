 CSP Configuration
Your existing CSP is mostly correct but needs refinement for reCAPTCHA:

typescript
Copy
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
⌄
⌄
⌄
⌄
⌄
// Update helmet config in index.tsx
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      // ... other directives
      scriptSrc: [
        "'self'",
        "'unsafe-inline'", // Required for reCAPTCHA callbacks
        "https://www.google.com/recaptcha/",
        "https://www.gstatic.com/recaptcha/"
      ],
      frameSrc: [
        "'self'",
        "https://www.google.com/recaptcha/",
        "https://recaptcha.google.com/"
      ],
      // ... other directives
    },
  },
  // ... other helmet options
}));
2. CSRF Token Integration
Ensure the CSRF token is included in API requests:

Frontend Example :

javascript
Copy
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
⌄
⌄
⌄
⌄
// Get CSRF token from cookie
function getCsrfToken() {
  return document.cookie
    .split('; ')
    .find(row => row.startsWith('x-csrf-token='))
    ?.split('=')[1];
}

// Include token in headers
fetch('/api/leads', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': getCsrfToken() // Critical for CSRF protection
  },
  body: JSON.stringify({ 
    captchaToken: 'RECAPTCHA_TOKEN',
    // ... other data
  })
});
3. reCAPTCHA Script Loading
Ensure the reCAPTCHA script is loaded in your HTML template:

html
Copy
1
2
<!-- In your HTML head -->
<script src="https://www.google.com/recaptcha/api.js?render=YOUR_SITE_KEY"></script>
4. Critical Fixes
Verify reCAPTCHA Initialization :
For v2 Checkbox :
html
Copy
1
<div class="g-recaptcha" data-sitekey="YOUR_SITE_KEY"></div>
For v2 Invisible :
javascript
Copy
1
2
3
4
⌄
window.onSubmit = async () => {
  const token = await grecaptcha.execute('YOUR_SITE_KEY', { action: 'submit' });
  // Include token in your API request
};
Check Environment Variables :
Ensure these are set in your .env:
Copy
1
2
RECAPTCHA_SECRET_KEY=your_secret_key
SESSION_SECRET=your_secure_random_string
Domain Whitelisting :
Add your domain (e.g., localhost, Replit URL) to the A